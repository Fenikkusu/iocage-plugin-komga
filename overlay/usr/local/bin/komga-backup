#!/bin/sh

usage()
{
    cat <<EOS >&2
Usage: $(basename "$0") [OPTIONS]
  DESCRIPTION
    Backup Komga database file.
    This command depends on a few variables in /usr/local/etc/komga-plugin.conf.
  OPTIONS
    -t|--target target_db_file  Target sqlite database file
                                Default: $KOMGA_APP_DIR/database.sqlite
    -d|--dest dest_dir          Destination directory
                                Default: /usr/local/komga/backup
    -p|--prefix prefix          Backup file prefix
                                Default: komga_database_
    -h|--help                   Show usage
    --debug                     Execute with debug mode
  EXAMPLE
    * Back up to the default application directory.
      That is, make '/usr/local/komga/database.sqlite' a '/usr/local/komga/komga_database_YYYYmmddTHHMMSSTZ.sqlite' backup
      $ $(basename "$0")

    * Change the destination to '/mnt/backup'.
      $ $(basename "$0") -d /mnt/backup
EOS
}

parse_args()
{
    while [ $# -gt 0 ];
    do
        case $1 in
            --debug)
                set -x
            ;;

            --target|-t)
                KOMGA_BACKUP_DB_FILE=$2
                shift
            ;;

            --dest|-d)
                KOMGA_BACKUP_DEST_DIR=$2
                shift
            ;;

            --prefix|-p)
                KOMGA_BACKUP_PREFIX=$2
                shift
            ;;

            --help|-h)
                usage
                exit 0
            ;;

            *)
                echo "❌ Invalid option '$1'" >&2
                usage
                exit 1
            ;;
        esac
        shift
    done
}

init_params()
{
    : "${KOMGA_APP_DIR:=/usr/local/komga}"
    : "${KOMGA_BACKUP_DB_FILE:=$KOMGA_APP_DIR/database.sqlite}"
    : "${KOMGA_BACKUP_DEST_DIR:=/usr/local/komga/backup}"
    : "${KOMGA_BACKUP_PREFIX:=komga_database_}"
}

validate_params()
{
    if [ ! -f "$KOMGA_BACKUP_DB_FILE" ]; then
        echo "❌ Source file '$KOMGA_BACKUP_DB_FILE' does not exist or is not a file." >&2
        exit 1
    fi

    if [ ! -d "$KOMGA_BACKUP_DEST_DIR" ]; then
        # If either mkdir or chown fails, an error message will be printed and you will have to exit, ignore SC2015.
        # shellcheck disable=SC2015
        mkdir -p $KOMGA_BACKUP_DEST_DIR && chown komga $KOMGA_BACKUP_DEST_DIR || { echo "❌ Komga backup failed." >&2 ; exit 1; }
    fi
}

main()
{
    sqlite3 "$KOMGA_BACKUP_DB_FILE" ".backup ${KOMGA_BACKUP_DEST_DIR}/${KOMGA_BACKUP_PREFIX}$(date '+%Y%m%dT%H%M%S%z').sqlite"
}

. /usr/local/etc/komga-plugin.conf
parse_args "$@"
init_params
validate_params
main
