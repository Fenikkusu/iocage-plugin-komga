#!/bin/sh

. /usr/local/komga/.env

: "${KOMGA_APP_DIR:=/usr/local/komga}"

# Install or Update komga
cd $KOMGA_APP_DIR || { echo "❌ Komga app dir not found." >&2 ; exit 1; }
if [ -f "release-latest.json" ] ; then
    mv -f "release-latest.json" "release-previous.json"
fi
fetch -qo "release-latest.json" https://api.github.com/repos/gotson/komga/releases/latest || { echo "❌ Komga release info fetch failed." >&2 ; exit 1; }
jq '.assets[] | select(.name | test("komga.*\\.jar")) | .browser_download_url' release-latest.json | xargs fetch -q || { echo "❌ Komga jar fetch failed." >&2 ; exit 1; }
jar=$(jq -r '.assets[] | select(.name | test("komga.*\\.jar")) | .name' release-latest.json)
ln -sf "$jar" "komga.jar"
chown komga "$jar"

echo "✅ Successful fetch Komga latest version!"
echo "⚠ If komga is running, please restart it."
